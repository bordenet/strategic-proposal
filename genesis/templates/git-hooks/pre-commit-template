#!/usr/bin/env bash
################################################################################
# Pre-Commit Hook for {{PROJECT_NAME}}
################################################################################
# PURPOSE: Enforce quality standards before allowing commits
# INSTALLATION: Copy to .git/hooks/pre-commit and chmod +x
################################################################################

set -euo pipefail

# Colors
readonly COLOR_RED='\033[0;31m'
readonly COLOR_GREEN='\033[0;32m'
readonly COLOR_YELLOW='\033[1;33m'
readonly COLOR_RESET='\033[0m'

# Counters
CHECKS_PASSED=0
CHECKS_FAILED=0

# Logging
log_check() {
    echo -e "${COLOR_YELLOW}[CHECK]${COLOR_RESET} $*"
}

log_pass() {
    echo -e "${COLOR_GREEN}[✓]${COLOR_RESET} $*"
    ((CHECKS_PASSED++))
}

log_fail() {
    echo -e "${COLOR_RED}[✗]${COLOR_RESET} $*"
    ((CHECKS_FAILED++))
}

echo ""
echo "========================================="
echo "  Pre-Commit Quality Checks"
echo "========================================="
echo ""

# Check 1: ShellCheck on all shell scripts
log_check "Running ShellCheck on shell scripts..."
SHELL_SCRIPTS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.sh$' || true)

if [ -n "$SHELL_SCRIPTS" ]; then
    for script in $SHELL_SCRIPTS; do
        if [ -f "$script" ]; then
            if shellcheck "$script" 2>&1 | grep -qE "(warning|error)"; then
                log_fail "ShellCheck failed for $script"
                shellcheck "$script"
            else
                log_pass "ShellCheck passed for $script"
            fi
        fi
    done
else
    log_pass "No shell scripts to check"
fi

# Check 2: JavaScript syntax
log_check "Checking JavaScript syntax..."
JS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.js$' || true)

if [ -n "$JS_FILES" ]; then
    for jsfile in $JS_FILES; do
        if [ -f "$jsfile" ]; then
            if node --check "$jsfile" 2>&1 | grep -q "error"; then
                log_fail "JavaScript syntax error in $jsfile"
                node --check "$jsfile"
            else
                log_pass "JavaScript syntax valid for $jsfile"
            fi
        fi
    done
else
    log_pass "No JavaScript files to check"
fi

# Check 3: Shell script standards compliance
log_check "Verifying shell script standards..."
if [ -n "$SHELL_SCRIPTS" ]; then
    for script in $SHELL_SCRIPTS; do
        if [ -f "$script" ]; then
            # Check for help flag
            if ! grep -q "show_help\|-h\|--help" "$script"; then
                log_fail "$script missing help flag (-h|--help)"
            else
                log_pass "$script has help flag"
            fi
            
            # Check for verbose flag
            if ! grep -q "VERBOSE\|-v\|--verbose" "$script"; then
                log_fail "$script missing verbose flag (-v|--verbose)"
            else
                log_pass "$script has verbose flag"
            fi
            
            # Check for timer (either implementation or sourcing common.sh)
            if ! grep -q "update_timer\|TIMER_PID\|source.*common.sh" "$script"; then
                log_fail "$script missing timer implementation"
            else
                log_pass "$script has timer implementation"
            fi
        fi
    done
fi

# Check 4: No TODO comments in staged files
log_check "Checking for TODO comments..."
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
TODO_COUNT=0

for file in $STAGED_FILES; do
    if [ -f "$file" ] && grep -qE "TODO|FIXME" "$file"; then
        log_fail "TODO/FIXME found in $file"
        ((TODO_COUNT++))
    fi
done

if [ $TODO_COUNT -eq 0 ]; then
    log_pass "No TODO/FIXME comments found"
fi

# Check 5: No console.log in JavaScript files
log_check "Checking for console.log statements..."
CONSOLE_LOG_COUNT=0

if [ -n "$JS_FILES" ]; then
    for jsfile in $JS_FILES; do
        if [ -f "$jsfile" ] && grep -q "console\.log" "$jsfile"; then
            log_fail "console.log found in $jsfile"
            ((CONSOLE_LOG_COUNT++))
        fi
    done
fi

if [ $CONSOLE_LOG_COUNT -eq 0 ]; then
    log_pass "No console.log statements found"
fi

# Summary
echo ""
echo "========================================="
echo "  Summary"
echo "========================================="
echo -e "Checks passed: ${COLOR_GREEN}${CHECKS_PASSED}${COLOR_RESET}"
echo -e "Checks failed: ${COLOR_RED}${CHECKS_FAILED}${COLOR_RESET}"
echo ""

if [ $CHECKS_FAILED -gt 0 ]; then
    echo -e "${COLOR_RED}❌ Commit rejected due to quality check failures${COLOR_RESET}"
    echo ""
    echo "Please fix the issues above and try again."
    echo ""
    exit 1
fi

echo -e "${COLOR_GREEN}✅ All quality checks passed - proceeding with commit${COLOR_RESET}"
echo ""
exit 0

